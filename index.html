<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RBC Wealth Map ‚Äì v12.1</title>
<link rel="stylesheet" href="styles.css" />
</head>
<body>
<header>
  <div class="rbc-branding">
    <div class="rbc-logo">
      <div class="rbc-shield">RBC</div>
      <span>Wealth Management CRM</span>
    </div>
  </div>
  <div class="toolbar">
    <div class="left">
      <button class="btn primary" id="addRoot" type="button">New Map</button>
      <select id="templateSelect" title="Template">
        <option value="">Template: none</option>
        <option>Client</option><option>COI</option><option>Account</option><option>Task</option>
        <option>Opportunity</option><option>Recurring Contact</option><option>Note</option><option>Sub-Tree</option>
      </select>
      <button class="btn" id="addChild" type="button">Add Child</button>
      <label style="display:flex;gap:6px;align-items:center">Activity offset
        <input id="defaultOffset" type="number" min="0" value="7" style="width:60px" />
      </label>
      <button class="btn" id="editNode" type="button">Edit</button>
      <button class="btn" id="toggleHighlight" type="button">Flag</button>
      <button class="btn" id="foldBtn" type="button">Fold</button>
      <button class="btn danger" id="deleteNode" type="button">Delete</button>
      <button class="btn" id="mailingBtn" type="button">Mailing</button>
      <div class="search-container">
        <input id="search" type="text" placeholder="Search nodes‚Ä¶" />
        <button class="btn small" id="searchHelpBtn" type="button" title="Search help">?</button>
      </div>
    </div>
    <div class="right">
      <div class="toggle" role="tablist" aria-label="View mode">
        <button class="btn active" id="viewMind" type="button">Mind Map</button>
        <button class="btn" id="viewList" type="button">Tasks</button>
        <button class="btn" id="viewAnalytics" type="button">Analytics</button>
      </div>
      <span id="undoIndicator" class="undo-indicator" title="Undo: Ctrl+Z, Redo: Ctrl+Shift+Z">0 undo</span>
      <button class="btn" id="shortcutsBtn" type="button" title="Keyboard shortcuts">‚å®</button>
      <div class="toggle" aria-label="Zoom">
        <button class="btn" id="zoomOut" type="button">‚àí</button>
        <button class="btn" id="zoomReset" type="button">100%</button>
        <button class="btn" id="zoomIn" type="button">+</button>
      </div>
      <button class="btn" id="distributeBtn" type="button" title="Auto-arrange">Arrange</button>
      <button class="btn accent" id="saveBtn" type="button">Save</button>
      <button class="btn" id="loadBtn" type="button">Load</button>
      <button class="btn" id="backupsBtn" type="button">Backups</button>
      <input type="file" id="fileInput" accept="application/json" style="display:none" />
    </div>
  </div>
</header>

<main>
  <section id="mindmapView" class="active" aria-label="Mind Map">
    <div class="stage-wrap" id="stageWrap">
      <div class="stage" id="stage" style="transform: translate(40px,45px) scale(1)">
        <svg class="links" id="linkLayer"></svg>
        <div id="nodeLayer"></div>
      </div>
    </div>
    <div class="stats-bar">
      <div class="stat">
        <span>Total Clients:</span>
        <span class="stat-value" id="statClients">0</span>
      </div>
      <div class="stat">
        <span>Total AUM:</span>
        <span class="stat-value" id="statAUM">$0</span>
      </div>
      <div class="stat">
        <span>Active Tasks:</span>
        <span class="stat-value" id="statTasks">0</span>
      </div>
      <div class="stat">
        <span>Opportunities:</span>
        <span class="stat-value" id="statOpps">0</span>
      </div>
    </div>
  </section>
  <section id="listView" aria-label="Task List">
    <div class="list-toolbar">
      <select id="listSort">
        <option value="due">Sort by due date</option>
        <option value="status">Sort by status</option>
        <option value="title">Sort by title</option>
      </select>
      <div class="toggle" id="statusFilters" aria-label="Task filters">
        <button class="btn active" data-filter="now" type="button">Now</button>
        <button class="btn" data-filter="todo" type="button">To do</button>
        <button class="btn" data-filter="inprogress" type="button">In progress</button>
        <button class="btn" data-filter="blocked" type="button">Blocked</button>
        <button class="btn" data-filter="done" type="button">Done</button>
        <button class="btn" data-filter="overdue" type="button">Overdue</button>
      </div>
      <button class="btn" id="expandAll" type="button">Expand all</button>
      <button class="btn" id="collapseAll" type="button">Collapse all</button>
    </div>
    <div class="list" id="taskList"></div>
  </section>
  <section id="analyticsView" aria-label="Analytics Dashboard">
    <div class="analytics-container">
      <h2>Weekly Business Development Tracking</h2>
      <p class="muted">Touch data syncs with weekly tracker (localStorage: bd_week_YYYY-MM-DD)</p>
      <div class="analytics-grid">
        <div class="analytics-card">
          <h3>üìû Calls</h3>
          <div class="analytics-stat">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="calls-today">0/20</div>
          </div>
          <div class="analytics-stat">
            <div class="stat-label">This Week</div>
            <div class="stat-value" id="calls-week">0/100</div>
          </div>
        </div>
        <div class="analytics-card">
          <h3>üíº LinkedIn</h3>
          <div class="analytics-stat">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="linkedin-today">0/20</div>
          </div>
          <div class="analytics-stat">
            <div class="stat-label">This Week</div>
            <div class="stat-value" id="linkedin-week">0/100</div>
          </div>
        </div>
        <div class="analytics-card">
          <h3>üìß Emails</h3>
          <div class="analytics-stat">
            <div class="stat-label">Today</div>
            <div class="stat-value" id="emails-today">0/20</div>
          </div>
          <div class="analytics-stat">
            <div class="stat-label">This Week</div>
            <div class="stat-value" id="emails-week">0/100</div>
          </div>
        </div>
      </div>
      <div class="analytics-card" style="margin-top: 20px">
        <h3>All-Time Averages (per day)</h3>
        <div class="analytics-stats-row">
          <div class="analytics-stat">
            <div class="stat-label">Calls</div>
            <div class="stat-value" id="calls-avg">0.0</div>
          </div>
          <div class="analytics-stat">
            <div class="stat-label">LinkedIn</div>
            <div class="stat-value" id="linkedin-avg">0.0</div>
          </div>
          <div class="analytics-stat">
            <div class="stat-label">Emails</div>
            <div class="stat-value" id="emails-avg">0.0</div>
          </div>
        </div>
      </div>
      <div class="muted" style="margin-top: 20px; text-align: center">
        Viewing current week: <span id="analytics-week-label">‚Äî</span><br>
        Full tracker available at: <a href="../import/weekly_business_development_checklist.html" target="_blank">weekly_business_development_checklist.html</a>
      </div>
    </div>
  </section>
</main>

<!-- Editor Modal -->
<div class="modal-backdrop" id="editorBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
    <h3 id="editorTitle">Edit Node</h3>
    <div class="grid2">
      <div class="field"><label for="f_title">Title</label><input id="f_title" /></div>
      <div class="field"><label for="f_template">Template</label><select id="f_template"></select></div>
      <div class="field"><label for="f_status">Status</label><select id="f_status">
        <option value="todo">To do</option>
        <option value="inprogress">In progress</option>
        <option value="blocked">Blocked</option>
        <option value="done">Done</option>
      </select></div>
      <div class="field"><label for="f_due">Due date</label><input id="f_due" type="date" /></div>
      <div class="field"><label for="f_lastcontact">Last Contact</label><input id="f_lastcontact" type="date" /></div>
      <div class="field"><label for="f_nextcontact">Next Contact</label><input id="f_nextcontact" type="date" /></div>
      <div class="field"><label for="f_freq">Contact Frequency</label><select id="f_freq">
        <option value="">‚Äî</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="biannually">Bi-Annually</option>
        <option value="annually">Annually</option>
      </select></div>
      <div class="field" id="touchField" style="grid-column:1 / -1;display:none">
        <label>Record Touch (if Last Contact updated)</label>
        <div class="touch-checkboxes">
          <label class="touch-check"><input type="checkbox" id="touch_calls" value="calls" /><span>üìû Call</span></label>
          <label class="touch-check"><input type="checkbox" id="touch_linkedin" value="linkedin" /><span>üíº LinkedIn</span></label>
          <label class="touch-check"><input type="checkbox" id="touch_emails" value="emails" /><span>üìß Email</span></label>
        </div>
      </div>
      <div class="field"><label>Node Color</label><div id="colorPalette" class="palette"></div></div>
      <div class="field" style="grid-column:1 / -1">
        <label for="f_notes">Notes</label>
        <textarea id="f_notes" rows="3" placeholder="Details, next steps, context"></textarea>
      </div>
    </div>
    <h3 style="margin-top:20px">Record fields</h3>
    <div id="kvArea"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="addKV" type="button">Add field</button>
      <button class="btn" id="importAccounts" type="button" title="Import CSV">Import CSV</button>
    </div>
    <div class="actions">
      <button class="btn" id="cancelEdit" type="button">Cancel</button>
      <button class="btn accent" id="saveEdit" type="button">Save</button>
    </div>
  </div>
</div>

<!-- Backups Modal -->
<div class="modal-backdrop" id="backupsBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="backupsTitle">
    <h3 id="backupsTitle">Backups</h3>
    <div id="backupsList" class="list" style="max-height:50vh;overflow:auto"></div>
    <div class="actions">
      <button class="btn" id="closeBackups" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Mailing Modal -->
<div class="modal-backdrop" id="mailingBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="mailingTitle">
    <h3 id="mailingTitle">Mailing List</h3>
    <div class="field">
      <label>Audience</label>
      <select id="audience">
        <option value="clientsOpps">All Clients & Opportunities</option>
        <option value="byTags">By Tags‚Ä¶</option>
        <option value="clientsCoi">All Clients & COIs</option>
      </select>
    </div>
    <div class="field">
      <label>Filter Tags (when By Tags selected)</label>
      <input id="tagsFilter" type="text" placeholder="comma-separated tags (e.g., client, quarterly, vip)" />
    </div>
    <div class="field">
      <label>Preview (first 50)</label>
      <div id="mailingPreview" class="list" style="max-height:40vh;overflow:auto"></div>
    </div>
    <div class="actions">
      <button class="btn" id="refreshPreview" type="button">Refresh</button>
      <button class="btn accent" id="downloadCSV" type="button">Download CSV</button>
      <button class="btn" id="closeMailing" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Search Help Modal -->
<div class="modal-backdrop" id="searchHelpBackdrop" aria-hidden="true">
  <div class="modal small" role="dialog" aria-modal="true" aria-labelledby="searchHelpTitle">
    <h3 id="searchHelpTitle">Advanced Search Help</h3>
    <div class="help-content">
      <h4>Simple Search</h4>
      <p>Type any text to search across all fields:</p>
      <code>john</code>

      <h4>Field-Specific Search</h4>
      <p>Search specific fields using <strong>field:value</strong> syntax:</p>
      <code>Email:john@example.com</code><br>
      <code>template:Client</code><br>
      <code>status:A-tier</code><br>
      <code>title:Follow up</code>

      <h4>Numeric Comparisons</h4>
      <p>Use <strong>&gt;</strong> or <strong>&lt;</strong> for numeric fields:</p>
      <code>AUM:&gt;1000000</code><br>
      <code>AUM:&lt;500000</code>

      <h4>Contains Operator</h4>
      <p>Use <strong>*</strong> for substring matching:</p>
      <code>Notes:*urgent</code>

      <h4>Multi-Criteria Search</h4>
      <p>Combine multiple criteria with spaces (AND logic):</p>
      <code>template:Client status:A-tier</code><br>
      <code>template:Opportunity AUM:&gt;500000</code>

      <h4>Available Fields</h4>
      <p>template, status, title, due, notes, freq, Email, Cell Number, AUM, Birthday, Last Contact, Next Contact, Tags, and any custom fields</p>
    </div>
    <div class="actions">
      <button class="btn accent" id="closeSearchHelp" type="button">Got it</button>
    </div>
  </div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal-backdrop" id="shortcutsBackdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="shortcutsTitle">
    <h3 id="shortcutsTitle">Keyboard Shortcuts</h3>
    <div class="shortcuts-grid">
      <div class="shortcut-section">
        <h4>Navigation</h4>
        <div class="shortcut-item">
          <kbd>‚Üë ‚Üì ‚Üê ‚Üí</kbd>
          <span>Navigate nodes</span>
        </div>
      </div>
      <div class="shortcut-section">
        <h4>Node Actions</h4>
        <div class="shortcut-item">
          <kbd>E</kbd>
          <span>Edit selected node</span>
        </div>
        <div class="shortcut-item">
          <kbd>C</kbd>
          <span>Add child node</span>
        </div>
        <div class="shortcut-item">
          <kbd>Delete</kbd>
          <span>Delete node</span>
        </div>
        <div class="shortcut-item">
          <kbd>F</kbd>
          <span>Fold/unfold node</span>
        </div>
        <div class="shortcut-item">
          <kbd>H</kbd>
          <span>Highlight/flag node</span>
        </div>
        <div class="shortcut-item">
          <kbd>D</kbd>
          <span>Auto-arrange subtree</span>
        </div>
        <div class="shortcut-item">
          <kbd>T</kbd>
          <span>Touch current node</span>
        </div>
      </div>
      <div class="shortcut-section">
        <h4>Undo/Redo</h4>
        <div class="shortcut-item">
          <kbd>Ctrl+Z</kbd>
          <span>Undo</span>
        </div>
        <div class="shortcut-item">
          <kbd>Ctrl+Shift+Z</kbd>
          <span>Redo</span>
        </div>
      </div>
      <div class="shortcut-section">
        <h4>Search</h4>
        <div class="shortcut-item">
          <kbd>Esc</kbd>
          <span>Clear search (in search box)</span>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn accent" id="closeShortcuts" type="button">Close</button>
    </div>
  </div>
</div>

<div class="hint" id="hint">v13.0.2: Parent touch sync ‚Ä¢ Enforced classification ‚Ä¢ Analytics view ‚Ä¢ Shortcuts</div>

<!-- Load modules in dependency order -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/validation.js"></script>
<script src="js/dom-refs.js"></script>
<script src="js/state.js"></script>
<script src="js/undo.js"></script>
<script src="js/node-operations.js"></script>
<script src="js/render.js"></script>
<script src="js/storage.js"></script>
<script src="js/analytics.js"></script>
<script src="js/touch-tracker.js"></script>
<script src="js/editor.js"></script>
<script src="js/modals.js"></script>
<script src="js/events.js"></script>
<script src="js/search-advanced.js"></script>
<script src="js/main.js"></script>
</body>
</html>
